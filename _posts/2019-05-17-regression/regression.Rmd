---
title: "Rで最小二乗法"
description: |
  Rで最小二乗法を行う方法を説明します。
author:
  - name: 土井　翔平
    affiliation: 国立情報学研究所
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 2
categories:
  - R
  - data analysis
twitter:
  creator: "@sdoi0504"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  error = TRUE,
  warning = TRUE,
  message = TRUE,
  R.options = list(width = 100)
)
```

## はじめに {#Intro}

データ分析の目的の一つは何かを何かで予測したり、説明したりすることです。
例えば、気温からビールの売上を予測・説明するといった具合です。

いろいろな分野や流派で同じことを違う言葉で表現しますが、予測において予測したい変数を目的変数、予測に使う変数を特徴量と呼びます。
先程の例で言えば気温が特徴量でビールの売上が目的変数です。

統計学や計量経済学では説明したい変数を従属変数、非説明変数などと呼び、説明に使う変数を独立変数、統制変数、説明変数と呼びます。
因果推論を強調する場合は説明したい変数を応答変数、説明に使う変数を処置（変数）、処置以外を共変量と呼んだりもします。

以下では有権者のデータを使ってRで回帰分析をする基本的な方法を説明していきます。
そのため、あえて数学的には厳密でない表現を使っているところもありますが、ご容赦ください。

### 必要なパッケージの読み込み

```{r}
library(tidyverse)
```

### データの読み込み

[東大・朝日共同調査](http://www.masaki.j.u-tokyo.ac.jp/utas/utasv.html)の2014年衆院選・2016年参院選世論調査のデータを使います。

```{r}
data <- read_csv("http://www.masaki.j.u-tokyo.ac.jp/utas/2014_2016UTASV20161004.csv", 
                 locale = locale(encoding = "shift-jis"), na = c("66", "99", "999"))
```

- 非該当は`66`で、無回答は`99`なので、これらを欠損値として読み込んでおきます。

なお、以下で特に断りのない限り、2014年の衆院選のデータを使います。

## 最小二乗法 {#OLS}

最も基本的な回帰分析である最小二乗法についてまずは説明します。

有権者の感情温度を分析したいと思います。
感情温度とは

> あなたは、次の①から⑪の政党や政治家に対し、好意的な気持ちを持っていますか、それとも反感を持っていますか。好意も反感も持たないときは、下の「感情温度計」で50度としてください。好意的な気持ちがあれば、その強さに応じて51度から100度、また、反感を感じていれば、49度から0度のどこかの数字で答えてください

という質問の答えです。

### 最小二乗法の前提

ここでは自民党に対する感情温度に関心があるとします。
また、性別によってそれは変化すると考えているとします。

ここで、$i$さんの自民党の感情温度を$y_i$、性別を$X_i$＄とすると、次のような式で表現できる、というのが最小二乗法の前提です。

$$
  y_i = \beta_0 + \beta_1 X_i + \varepsilon_i
$$

例えば、$X_i$は男性のときには0で女性のときには1になるとします。
すると$i$が男性のときには$y_i = \beta_0 + \varepsilon_i$となり、女性のときには$y_i = \beta_0 + \beta_1 + \varepsilon_i$となります。

ひとまず、$\varepsilon_i$のことは無視しておくと、$\beta_0$は男性のときの自民党への感情温度で、$\beta_1$は男性と女性の感情温度の差であるという意味になります。
この$\beta_0$や$\beta_1$が分かれば、男性と女性の自民党に対する感情温度を予測したり説明することができます。

さて、この$\varepsilon_i$は誤差項や撹乱項と呼ばれるもので、$X_i$以外の$y_i$に影響する全ての要素、です。
例えば年齢や職業、住んでいる場所も自民党への感情温度には影響するかもしれませんが、$X_i$には含まれていないので誤差項に含まれていると考えます。

問題はこの誤差項は観察できない要素が含まれている点です。
例えば、調査を受けた時の気分によっても自民党への感情温度の解答は変わるかもしれません。

もし、誤差項がなければ、データ$(y_i,X_i)$から男性の感情温度$\beta_0$と女性の感情温度$\beta_0+\beta_1$が分かります。
そして、そこから$\beta_0$と$\beta_1$観察することはできます。
しかし、誤差項があるので我々は$\beta_0$と$\beta_1$を観察することができません。

### 最小二乗法でやっていること

そこで、それらしい$\beta_0$と$\beta_1$を推定するための方法が最小二乗法になります。

まず、当てずっぽうに$\hat{\beta}_0$と$\hat{\beta}_1$を決めます。
そして、そこから$y_i$の予測値として$\hat{y}_i = \hat{\beta}_0 + \hat{\beta}_1 X_i$を求めます。

当然、予測値$\hat{y}_i$と観測値$y_i$が全ての$i$さんについて一致することはありません。
そこで、観測値と予測値の差を$e_i = y_i - \hat{y}_i$として求める、残差と名付けます。

<aside>
  誤差項と残差はしばしば混同されますが違う概念です。
</aside>

この残差が一番小さくなるような$\hat{\beta}_0$と$\hat{\beta}_1$が$\beta_0$と$\beta_1$の推定値としていいんじゃないだろうか、というのが最小二乗法の基本的な発想です。
最小二乗法と呼ばれる所以は、残差の**二乗**$e_i^2$の総和を**最小**にするからです。

*（2019年5月23日追記）*図にすると次のようになります。
各点が観察を表していて、斜めの直線が予測線になります。
各点から予測線への垂線が残差になります。
このズレが最小になるような予測線の切片と傾きを求める方法が最小二乗法になります。

```{r}
n <- 50
tibble(x = rnorm(n, 0, 1),
       y = x + rnorm(n, 0, 1)) %>% 
  ggplot() + 
  geom_point(aes(x = x, y = y)) + 
  geom_line(aes(x = x, y = x)) + 
  geom_errorbar(aes(x = x, ymin = x, ymax = y))
```


### Rによる最小二乗法

まず準備として性別の変数を修正します。
このデータでは男性が`1`で女性が`2`なので、`1`を引いて男性が`0`、女性が`1`となるようにします。

```{r}
data <- data %>% 
  mutate(W1F1 = W1F1 - 1)
```

最小二乗法を行う際には`lm()`を使います。
基本的に

1. `formula`によって`y_i`と`X_i`を定義し、
1. `data`によって使用するデータを選択します。

その結果を`model1`という名前のオブジェクトに保存しておきます。

```{r}
model1 <- lm(W1Q15_1 ~ W1F1, data = data)
```

結果を保存したオブジェクトを`summary()`に入れると分析結果が表示されます。

```{r}
summary(model1)
```

### 最小二乗法の分析結果

1. `(Intercept)`の`Estimate`が$\hat{\beta}_0$に、`W1F1`の`Estimate`が$\hat{\beta}_1$になります。
つまり、女性の方が自民党への感情温度が低いことが分かります。
2. `Std. Error`や`t vale`、`Pr(>|t|)`などはやや複雑なので割愛しますが、分析結果がたまたまなのかに関する指標です。
今回の場合、女性の方が男性に比べて約2.3度感情温度が低いという結果は偶然だとすれば3%の確率でしか生じないということがわかります。
3. `Residuals`とは残差のことです。
つまり、予測値と観測値のズレが-53.2から49.1くらいあるということです。
この最小値と最大値は男性なのに0度と答えた人や、逆に女性だけど100度と答えた人になります。
4. 最後に、下から2行目に`R-squared`というものがあります。
これは$R^2$と書かれたりもするのですが、$X_i$によってどれだけ$y_i$を予測できるのかを示しています。
大雑把に言って、性別は自民党への感情温度の0.2%としか予測できていないと言えます。

### 分析の可視化

ちなみに、グラフにするとこうなります。

```{r}
data %>% 
  ggplot(aes(x = W1F1, y = W1Q15_1)) + 
  geom_jitter() + 
  geom_smooth(method = "lm")
```

## 最小二乗法の拡張 {#Advanced}

### 複数の特徴量

最小二乗法において$X_i$の数は一つである必要はありません。
一般的に$m$個の特徴量、説明変数を入れることができます。

$$
  y_i = \beta_0 + \beta_1 X_{i1} + \cdots \beta_m X_{im} + \varepsilon_iｙ
$$

Rで分析する際には`formula`において`+`で変数を増やします。
試しに、年齢を入れて、次のようなモデルを推定します。

$$
  y_i = \beta_0 + \beta_1 \mathit{sex} + \beta_2 \mathit{age} + \varepsilon_i
$$

```{r}
model2 <- lm(W1Q15_1 ~ W1F1 + W1F2, data = data)
summary(model2)
```

`WF2`の`Estimate`が正なので年齢が上がると自民党への感情温度が上がることが分かりました。

- 複数の変数がある場合の可視化はちょっと面倒くさいです。

### 多項式

若者も自民党に好意的ではないかと思うのが人情だと思います。
そういう場合には年齢の二乗項を入れることで分析できます。

<aside>
  二次関数の上に凸、下に凸の放物線を思い浮かべてください。
</aside>

$$
  y_i = \beta_0 + \beta_1 \mathit{age} + \beta_2 \mathit{age}^2 + \varepsilon_i
$$

Rで二乗項や三乗項などを入れる場合は`poly()`を使います。

```{r}
model3 <- lm(W1Q15_1 ~ poly(W1F2, 2, raw = TRUE), data = data)
summary(model3)
```

年齢の二乗項`poly(W1F2, 2)2`が正なので下向きに凸ということを意味しています。
ということは両端（若者と老人）で自民党への感情温度が高いと言えます。

```{r}
data %>% 
  ggplot(aes(x = W1F2, y = W1Q15_1)) + 
  geom_jitter() + 
  geom_smooth(method = "lm", formula = y ~ poly(x,2))
```

### 交差項

それでは、年齢による違いは性別によっても違うのではないだろうか、と思うひともいるかと思います。
例えば、女性は年齢にかかわらず自民党への感情温度は低いままかもしれません。

このような場合は性別と年齢をかけ合わせたもの、いわゆる交差項を入れることで分析できます。
数式で表すとこの通りです。

$$
  y_i = \beta_0 + \beta_1 \mathit{sex} + \beta_2 \mathit{age} + \beta_3 \mathit{sex} \times \mathit{age} + \varepsilon_i
$$

なぜ、この式で男女における年齢の違いが分かるのでしょうか？
仮に男性の場合、$\mathit{se}$は0なので、

$$
  y_i = \beta_0 + \beta_2 \mathit{age}  + \varepsilon_i
$$

となります。
つまり、$\beta_2$は男性の場合の年齢と感情温度の関係を意味しています。

一方で、女性の場合は$\mathit{sex}$が1になるので、

$$
  y_i = \beta_0 + \beta_1 + \beta_2 \mathit{age} + \beta_3 \mathit{age} + \varepsilon_i
$$

となります。
もう少しわかりやすく整理すると、

$$
  y_i = (\beta_0 + \beta_1) + (\beta_2 + \beta_3) \mathit{age} + \varepsilon_i
$$

となります。
つまり、女性の場合の年齢と感情温度の関係は$\beta_2 + \beta_3$なのです。

さて、Rで交差項を入れるには`*`で掛け算をします。

```{r}
model4 <- lm(W1Q15_1 ~ W1F1*W1F2, data = data)
summary(model4)
```

交差項を含む分析の結果の解釈には注意が必要です。
まず、`W1F2`は正なっています。
これは$\beta_2$に相当するものなので、男性の場合は年齢が上がると自民党への感情温度が上がることを意味します。

一方、`W1F1:W1F2`は負です。
これを見ると女性は年齢が上がると自民党への感情温度が下がる、と思いそうです。
しかし、これは$\beta_3$に相当するものです。
女性における年齢と感情温度の関係は$\beta_2 + \beta_3$なので、引き算をしても依然として正であることがわかります。

```{r}
data %>% 
  ggplot(aes(x = W1F2, y = W1Q15_1, colour = as.factor(W1F1))) + 
  geom_jitter() + 
  geom_smooth(method = "lm", formula = y ~ x)
```

### てんこ盛りモデル

最後に、てんこ盛りにしたモデルを作ってみます。
二次関数とは言わずに五次関数にして、それぞれ性別によって変化するモデルを推定しちゃいましょう。

```{r}
model5 <- lm(W1Q15_1 ~ W1F1*poly(W1F2, 5, raw = TRUE), data = data)
summary(model5)
```

$R^2$を見ると0.029で、二次関数だけのモデル`model3`の0.019から少し改善していることがわかります。

```{r}
data %>% 
  ggplot(aes(x = W1F2, y = W1Q15_1, colour = as.factor(W1F1))) + 
  geom_jitter() + 
  geom_smooth(method = "lm", formula = y ~ poly(x, 5))
```

ただし、予測力が高くなっても説明力が高くなるとは限りません。