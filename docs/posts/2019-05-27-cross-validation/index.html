<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

  <!--radix_placeholder_meta_tags-->
<title>ノート: Rで機械学習：交差検証編</title>

<meta property="description" itemprop="description" content="機械学習をする際の注意点とRにおけるいくつかのテクニックを説明します。"/>

<link rel="canonical" href="https://shohei-doi.github.io/notes/posts/2019-05-27-cross-validation/"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2019-05-28"/>
<meta property="article:created" itemprop="dateCreated" content="2019-05-28"/>
<meta name="article:author" content="土井　翔平"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="ノート: Rで機械学習：交差検証編"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="機械学習をする際の注意点とRにおけるいくつかのテクニックを説明します。"/>
<meta property="og:url" content="https://shohei-doi.github.io/notes/posts/2019-05-27-cross-validation/"/>
<meta property="og:image" content="https://shohei-doi.github.io/notes/posts/2019-05-27-cross-validation/cross-validation_files/figure-html5/unnamed-chunk-7-1.png"/>
<meta property="og:image:width" content="1248"/>
<meta property="og:image:height" content="768"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="ノート"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="ノート: Rで機械学習：交差検証編"/>
<meta property="twitter:description" content="機械学習をする際の注意点とRにおけるいくつかのテクニックを説明します。"/>
<meta property="twitter:url" content="https://shohei-doi.github.io/notes/posts/2019-05-27-cross-validation/"/>
<meta property="twitter:image" content="https://shohei-doi.github.io/notes/posts/2019-05-27-cross-validation/cross-validation_files/figure-html5/unnamed-chunk-7-1.png"/>
<meta property="twitter:image:width" content="1248"/>
<meta property="twitter:image:height" content="768"/>
<meta property="twitter:creator" content="@sdoi0504"/>

<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","output","categories","twitter","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["Rで機械学習：交差検証編"]},{"type":"character","attributes":{},"value":["機械学習をする際の注意点とRにおけるいくつかのテクニックを説明します。"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation"]}},"value":[{"type":"character","attributes":{},"value":["土井　翔平"]},{"type":"character","attributes":{},"value":["国立情報学研究所"]}]}]},{"type":"character","attributes":{},"value":["2019-05-28"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","toc_depth"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"integer","attributes":{},"value":[2]}]}]},{"type":"character","attributes":{},"value":["R","data analysis"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["creator"]}},"value":[{"type":"character","attributes":{},"value":["@sdoi0504"]}]},{"type":"character","attributes":{},"value":["https://shohei-doi.github.io/notes/posts/2019-05-27-cross-validation/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["cross-validation_files/bowser-1.9.3/bowser.min.js","cross-validation_files/distill-2.2.21/template.v2.js","cross-validation_files/figure-html5/unnamed-chunk-15-1.png","cross-validation_files/figure-html5/unnamed-chunk-16-1.png","cross-validation_files/figure-html5/unnamed-chunk-7-1.png","cross-validation_files/figure-html5/unnamed-chunk-8-1.png","cross-validation_files/jquery-1.11.3/jquery.min.js","cross-validation_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #455a64;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative;}
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

</style>

<link href="../../site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

d-article {
  padding-bottom: 30px;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for table of contents */

.d-toc {
  color: rgba(0,0,0,0.8);
  font-size: 0.8em;
  line-height: 1em;
}

.d-toc-header {
  font-size: 0.6rem;
  font-weight: 400;
  color: rgba(0, 0, 0, 0.5);
  text-transform: uppercase;
  margin-top: 0;
  margin-bottom: 1.3em;
}

.d-toc a {
  border-bottom: none;
}

.d-toc ul {
  padding-left: 0;
}

.d-toc li>ul {
  padding-top: 0.8em;
  padding-left: 16px;
  margin-bottom: 0.6em;
}

.d-toc ul,
.d-toc li {
  list-style-type: none;
}

.d-toc li {
  margin-bottom: 0.9em;
}

.d-toc-separator {
  margin-top: 20px;
  margin-bottom: 2em;
}

.d-article-with-toc {
  border-top: none;
  padding-top: 0;
}



/* Tweak code blocks (note that this CSS is repeated above in an injection
   into the d-code shadow dom) */

d-code {
  overflow-x: auto !important;
}

pre.d-code code.d-code {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

pre.text-output {

  font-size: 12px;
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

@media(min-width: 768px) {

d-code {
  overflow-x: visible !important;
}

pre.d-code code.d-code  {
    padding-left: 18px;
    font-size: 14px;
}
pre.text-output {
  font-size: 14px;
}
}

/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure img {
  width: 100%;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}



/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}


/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // create d-bibliography
  var bibliography = $('<d-bibliography></d-bibliography>');
  $('#distill-bibliography').wrap(bibliography);

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace citations with <d-cite>
  $('.citation').each(function(i, val) {
    appendix = true;
    var cites = $(this).attr('data-cites').split(" ");
    var dt_cite = $('<d-cite></d-cite>');
    dt_cite.attr('key', cites.join());
    $(this).replaceWith(dt_cite);
  });
  // remove refs
  $('#refs').remove();

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-toc a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // replace code blocks with d-code
  $('pre>code').each(function(i, val) {
    var code = $(this);
    var pre = code.parent();
    var clz = "";
    var language = pre.attr('class');
    if (language) {
      // map unknown languages to "clike" (without this they just dissapear)
      if ($.inArray(language, ["bash", "clike", "css", "go", "html",
                               "javascript", "js", "julia", "lua", "markdown",
                               "markup", "mathml", "python", "svg", "xml"]) == -1)
        language = "clike";
      language = ' language="' + language + '"';
      var dt_code = $('<d-code block' + language + clz + '></d-code>');
      dt_code.text(code.text());
      pre.replaceWith(dt_code);
    } else {
      code.addClass('text-output').unwrap().changeElementType('pre');
    }
  });

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('d-code, pre.text-output, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // table of contents
    if (have_authors) // adjust border if we are in authors
      $('.d-toc').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // inject pre code styles (can't do this with a global stylesheet b/c a shadow root is used)
    $('d-code').each(function(i, val) {
      var style = document.createElement('style');
      style.innerHTML = 'pre code { padding-left: 10px; font-size: 12px; border-left: 2px solid rgba(0,0,0,0.1); } ' +
                        '@media(min-width: 768px) { pre code { padding-left: 18px; font-size: 14px; } }';
      if (this.shadowRoot)
        this.shadowRoot.appendChild(style);
    });

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-toc-header').remove();
  $('.d-toc').remove();
  $('.d-toc-separator').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<!--/radix_placeholder_distill-->
  <script src="../../site_libs/jquery-1.11.3/jquery.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-75879658-3"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-75879658-3');
</script>
<!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Rで機械学習：交差検証編","description":"機械学習をする際の注意点とRにおけるいくつかのテクニックを説明します。","authors":[{"author":"土井　翔平","authorURL":"#","affiliation":"国立情報学研究所","affiliationURL":"#"}],"publishedDate":"2019-05-28T00:00:00.000+09:00","citationText":"翔平, 2019"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="../../index.html" class="title">ノート</a>
</div>
<div class="nav-right">
<a href="../../../index.html">Shohei Doi</a>
<a href="../../index.xml">
<i class="fa fa-rss"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Rで機械学習：交差検証編</h1>
<p>機械学習をする際の注意点とRにおけるいくつかのテクニックを説明します。</p>
</div>

<div class="d-byline">
  土井　翔平  (国立情報学研究所)
  
<br/>2019-05-28
</div>

<div class="d-article">
<h3 class="d-toc-header">Table of Contents</h3>
<nav class="d-toc" id="TOC">
<ul>
<li><a href="#Intro">はじめに</a></li>
<li><a href="#Overfitting">過学習</a></li>
<li><a href="#Feature">特徴量エンジニアリング</a></li>
<li><a href="#CV">交差検証</a></li>
</ul>
</nav>
<hr class="d-toc-separator"/>
<h2 id="Intro">はじめに</h2>
<p><a href="https://shohei-doi.github.io/notes/posts/2019-05-20-classification/">前回</a>は機械学習の中でも教師付き学習の分類について、いくつかの手法を見てきました。 今回は発展的なトピックをいくつか取り上げたいと思います。</p>
<h3>必要なパッケージの読み込み</h3>
<p>前回同様、<code>tidyverse</code>と<code>caret</code>を使います。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(tidyverse)</code></pre>
<pre><code>
Registered S3 methods overwritten by &#39;ggplot2&#39;:
  method         from 
  [.quosures     rlang
  c.quosures     rlang
  print.quosures rlang</code></pre>
<pre><code>
Registered S3 method overwritten by &#39;rvest&#39;:
  method            from
  read_xml.response xml2</code></pre>
<pre><code>
── Attaching packages ──────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>
✔ ggplot2 3.1.1       ✔ purrr   0.3.2  
✔ tibble  2.1.1       ✔ dplyr   0.8.0.1
✔ tidyr   0.8.3       ✔ stringr 1.4.0  
✔ readr   1.3.1       ✔ forcats 0.4.0  </code></pre>
<pre><code>
── Conflicts ─────────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>
library(caret)</code></pre>
<pre><code>
Loading required package: lattice</code></pre>
<pre><code>
Attaching package: &#39;caret&#39;</code></pre>
<pre><code>
The following object is masked from &#39;package:purrr&#39;:

    lift</code></pre>
</div>
<h3>必要なデータの読み込みと下ごしらえ</h3>
<p>例のごとく、<a href="http://www.masaki.j.u-tokyo.ac.jp/utas/utasv.html">東大・朝日共同調査</a>の2014年衆院選・2016年参院選世論調査のデータを使います。</p>
<ul>
<li>各コードで何をしているのかは前回を参照してください。</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
data &lt;- read_csv(&quot;http://www.masaki.j.u-tokyo.ac.jp/utas/2014_2016UTASV20161004.csv&quot;, 
                 locale = locale(encoding = &quot;shift-jis&quot;), na = c(&quot;66&quot;, &quot;99&quot;, &quot;999&quot;))%&gt;% 
  select(vote = W1Q1,
         party = W1Q2,
         sex = W1F1,
         age = W1F2,
         educ = W1F3,
         job = W1F4,
         W1Q7, W1Q8, W1Q9, W1Q10, W1Q11, W1Q12, W1Q13, W1Q14_1,
         W1Q15_1, W1Q15_2, W1Q15_3, W1Q15_4, W1Q15_5, W1Q15_6, 
         W1Q15_7, W1Q15_8, W1Q15_9, W1Q15_10, W1Q15_11, 
         W1Q16_1, W1Q16_2, W1Q16_3, W1Q16_4, W1Q16_5, W1Q16_6, 
         W1Q16_7, W1Q16_8, W1Q16_9, W1Q16_10, W1Q16_11, 
         W1Q16_12, W1Q16_13, W1Q16_14, W1Q16_15, W1Q16_16, W1Q16_17,
         W1Q17_1, W1Q17_2, W1Q17_3, W1Q17_4, W1Q17_5, W1Q17_6, 
         W1Q17_7, W1Q17_8, W1Q17_9, W1Q17_10, 
         W1Q18_1, W1Q19_1,
         W1Q20_1, W1Q20_2, W1Q20_3, W1Q20_4, W1Q20_5, W1Q20_6, W1Q20_7)%&gt;% 
  mutate(vote = vote - 1,
         vote = as.factor(vote),
         party = as.factor(party),
         sex = as.factor(sex),
         educ = as.factor(educ),
         job = as.factor(job))  %&gt;% 
  select(-party) %&gt;%
  rename(target = vote) %&gt;% 
  drop_na()</code></pre>
<pre><code>
Parsed with column specification:
cols(
  .default = col_character(),
  ID = col_double(),
  PREFEC = col_double(),
  HRDIST = col_double(),
  W1Q1 = col_double(),
  W1Q2 = col_double(),
  W1Q3 = col_double(),
  W1Q4 = col_double(),
  W1Q5_1 = col_double(),
  W1Q5_2 = col_double(),
  W1Q5_3 = col_double(),
  W1Q6 = col_double(),
  W1Q7 = col_double(),
  W1Q8 = col_double(),
  W1Q9 = col_double(),
  W1Q10 = col_double(),
  W1Q11 = col_double(),
  W1Q12 = col_double(),
  W1Q13 = col_double(),
  W1Q14_1 = col_double(),
  W1Q14_2_1 = col_double()
  # ... with 56 more columns
)</code></pre>
<pre><code>
See spec(...) for full column specifications.</code></pre>
<pre><code>
Warning: 8 parsing failures.
 row    col expected actual                                                                file
1810 PREFEC a double     -- &#39;http://www.masaki.j.u-tokyo.ac.jp/utas/2014_2016UTASV20161004.csv&#39;
1810 HRDIST a double     -- &#39;http://www.masaki.j.u-tokyo.ac.jp/utas/2014_2016UTASV20161004.csv&#39;
1811 PREFEC a double     -- &#39;http://www.masaki.j.u-tokyo.ac.jp/utas/2014_2016UTASV20161004.csv&#39;
1811 HRDIST a double     -- &#39;http://www.masaki.j.u-tokyo.ac.jp/utas/2014_2016UTASV20161004.csv&#39;
1812 PREFEC a double     -- &#39;http://www.masaki.j.u-tokyo.ac.jp/utas/2014_2016UTASV20161004.csv&#39;
.... ...... ........ ...... ...................................................................
See problems(...) for more details.</code></pre>
</div>
<p>今回は、投票するかどうかを予測するデータセットのみを使います。</p>
<h3>シード値の設定</h3>
<p>いくつかの分析手法では乱数を用います。 その名の通り乱数は毎回違う値が出てくるので、分析結果も変わってきます。</p>
<p>そこで、乱数を発生させるときの基準となるシード値を設定することで、毎回同じ乱数が発生するようにします。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
set.seed(334)</code></pre>
</div>
<h2 id="Overfitting">過学習</h2>
<p>前回、ランダムフォレストで投票行動がほぼ100%の確率で的中できることが分かりました。 しかし、実はあの予測精度にはからくりがあったのです。</p>
<p>我々が予測したいのは、大抵の場合、「未知」のデータに対してです。 しかし、前回は学習に使った「既知」のデータに対して予測をしていました。</p>
<p>その結果、どのような問題が生じるのかを確認します。</p>
<p>そこで、学習に使う訓練データ(training set)と予測に使う検証データ(test set)にデータを分割してみます。 <code>caret</code>では<code>createDataPartition()</code>で設定した割合にデータを分割します。 実際には観察のインデックスが返ってくるので、それによって訓練データを選択し、<code>-</code>をつけてそれ以外を検証データとして選択します。</p>
<aside>
より厳密に言えば、訓練データと評価データ、検証データの3つに分けた方がいいです。
</aside>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
ind_train &lt;- createDataPartition(y = data$target, p = 0.75,list = FALSE)
data_train &lt;- data[ind_train,]
data_test &lt;- data[-ind_train,]</code></pre>
</div>
<p>それぞれで、投票に参加した人の割合を計算ます。 つまり、全員投票に行くと予測したときの的中率で、ここからどれだけ改善されるかが重要になります。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mean(data_train$target == 1)</code></pre>
<pre><code>
[1] 0.7238205</code></pre>
<pre class="r"><code>
mean(data_test$target == 1)</code></pre>
<pre><code>
[1] 0.7231834</code></pre>
</div>
<p>概ね、どちらも72%であること、訓練データと検証データで偏りがないことがわかります。</p>
<p>そして、訓練データのみを用いてランダムフォレストで学習し、訓練データと検証データのそれぞれで予測を行います。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
vote_rf1 &lt;- train(
  target ~ .,
  data = data_train,
  method = &quot;rf&quot;
)

train_rf1 &lt;- confusionMatrix(predict(vote_rf1, data_train), data_train$target)
test_rf1 &lt;- confusionMatrix(predict(vote_rf1, data_test), data_test$target)
print(str_c(&quot;Accuracy (train):&quot;, train_rf1$overall[1]))</code></pre>
<pre><code>
[1] &quot;Accuracy (train):1&quot;</code></pre>
<pre class="r"><code>
print(str_c(&quot;Accuracy (test) :&quot;, test_rf1$overall[1]))</code></pre>
<pre><code>
[1] &quot;Accuracy (test) :0.73356401384083&quot;</code></pre>
</div>
<p>学習に使った訓練データでは、前回と同様に100%の予測精度を叩き出しましたが、検証データでは（全員、投票に行くと予測する）ベースラインの72%よりも1%高いだけです。</p>
<p>このように、訓練データを学習し<strong>すぎる</strong>ことで未知のデータに対する予測精度を落としてしまうことを過学習、過剰適合(overfitting)と呼びます。 逆に、未知のデータに対する予測能力のことを汎化性能と呼んだりもします。</p>
<h3>バイアス・バリアンス・トレードオフ</h3>
<p>過学習と汎化性能の問題はバイアス・バリアンス・トレードオフと呼ばれることもあります。 ここで言うバイアスとは予測と観測値のズレで、バリアンスとはモデルの複雑さを意味します。 つまり、予測と観測値のズレをなくそうとするとモデルが複雑になり、翻って過学習してしまうということになります。</p>
<p>例えば、以下のグラフでは<span class="math inline">\(y = x^2 + \varepsilon\)</span>という関係を前提としたシミュレーションデータになります。 青い線はそれを5次の多項式でフィットさせたもので、赤い線は2次の多項式でフィットさせたものになります。 青いほうがモデルが複雑でバイアスは小さいですが、予測値の変動、すなわちバリアンスが大きくなってしまいます。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
n &lt;- 10
tibble(x = rnorm(n, 0, 1),
       y = x^2 + rnorm(n, 0, 0.5)) %&gt;% 
  ggplot(aes(x = x, y = y)) + 
  geom_point() + 
  geom_smooth(method = &quot;lm&quot;, formula = y ~ poly(x,5), se = FALSE) + 
  geom_smooth(method = &quot;lm&quot;, formula = y ~ poly(x,2), se = FALSE, colour = &quot;red&quot;)</code></pre>
<p><img src="cross-validation_files/figure-html5/unnamed-chunk-7-1.png" width="624" /></p>
</div>
<h2 id="Feature">特徴量エンジニアリング</h2>
<p>つまり、機械学習による予測における課題とは、以下にして訓練データに過学習することなく、検証データや未知のデータに対する汎化性能を高めるのか、という点にあります。 そのための方法として、予測に用いる特徴量を適切に設定すること、いわゆる特徴量エンジニアリングが挙げられます。</p>
<h3>特徴選択</h3>
<p><a href="https://shohei-doi.github.io/notes/posts/2019-05-20-classification/">前回</a>は特徴量を増やすことで予測精度を高めましたが、特徴量を増やせばいいというわけでもありません。 特徴量が増えれば増えるほど、訓練データに過学習しやすくなります。</p>
<p>最も有効な方法は<strong>ドメイン知識</strong>（予測対象に関する実質的な知識）を踏まえて、予測に有効な特徴量を選択することです。 しかし、今回は別の方法で特徴選択を行ってみます。</p>
<p>まず、<code>caret</code>の<code>varImp()</code>という関数によって特徴量の重要性を求めることができます。 それを<code>plot()</code>ないし、<code>ggplot()</code>に入れることで重要性を可視化することができます。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
vote_rf1 %&gt;% 
  varImp() %&gt;% 
  ggplot(top = 20)</code></pre>
<p><img src="cross-validation_files/figure-html5/unnamed-chunk-8-1.png" width="624" /></p>
</div>
<p>グラフには現れてきませんが、重要性の低い変数を見ると性別や学歴、職業などが見つかります。 そこで、この3つの変数を除外して再びランダムフォレストで学習してみます。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
vote_rf2 &lt;- train(
  target ~ .,
  data = data_train %&gt;% 
    select(-sex, -educ, -job),
  method = &quot;rf&quot;
)

train_rf2 &lt;- confusionMatrix(predict(vote_rf2, data_train), data_train$target)
test_rf2 &lt;- confusionMatrix(predict(vote_rf2, data_test), data_test$target)
print(str_c(&quot;Accuracy (train):&quot;, train_rf2$overall[1]))</code></pre>
<pre><code>
[1] &quot;Accuracy (train):1&quot;</code></pre>
<pre class="r"><code>
print(str_c(&quot;Accuracy (test) :&quot;, test_rf2$overall[1]))</code></pre>
<pre><code>
[1] &quot;Accuracy (test) :0.730103806228374&quot;</code></pre>
</div>
<p>若干ではあるものの、予測精度が改善しました。 ポイントとしては、</p>
<ol type="1">
<li>特徴量は多ければいいというわけではないということ、</li>
<li>ドメイン知識に基づく特徴選択が有効な方法であるということ</li>
</ol>
<p>です。</p>
<h3>次元削減・特徴抽出</h3>
<p>機械学習による変数の削除は次元削減あるいは特徴抽出と呼ばれます。 代表的な手法として主成分分析(principal component analysis)というものがあります。</p>
<p>アイデアとしては、多くの変数は実はより少ない変数によって簡単に表現できるのだと仮定して、そのより少ない変数を見つける、というものです。 例えば、今回のデータセットには59個の特徴量がありますが、実は10個の目には見えない特徴量によって要約できるのだとします。</p>
<p>主成分分析は<code>caret</code>では<code>preProcess()</code>において<code>mthod = &quot;pca&quot;</code>によって訓練データで学習します。 <code>pcaComp</code>で主成分の数を指定します。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
pca &lt;- preProcess(data_train, method = &quot;pca&quot;, pcaComp = 10)</code></pre>
</div>
<p>学習した主成分分析を使って、訓練データと検証データから主成分を予測します。 連続変数が10の主成分に要約されます。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
data_train_pca &lt;- predict(pca, data_train)
data_test_pca &lt;- predict(pca, data_test)
data_train_pca %&gt;% 
  head()</code></pre>
<pre><code>
  target sex educ job       PC1        PC2        PC3        PC4         PC5        PC6        PC7
1      1   1    3   1  3.809366  0.1801622 -1.8379175  1.2456616  3.37083354 -1.9954919  1.8952302
2      1   2    4   3 -3.173918  1.5927561 -4.2498731 -1.1659160  1.24572074  0.3924708 -1.0146396
3      0   2    3   9 -2.461764 -0.8606923 -0.9490860 -0.7284149  1.25468156  0.5699500  0.7214223
4      0   1    3   1  1.957257 -1.9504894  0.5070019 -0.1784074  0.70948594  0.7019040  1.0983351
5      0   2    2   1 -3.660955 -1.6967464  2.0856792 -0.2048313  1.77887958  0.3399005 -0.5197844
6      0   2    3   5 -6.686003 -1.1631333  1.1502940 -0.4326285 -0.07474275 -0.9357342  0.4035839
         PC8        PC9       PC10
1  0.4845694 -1.5629032  1.7078777
2 -0.4276871 -0.2923143 -0.9699847
3 -1.1403454  1.3405139  1.3784887
4  0.6770817 -0.6356769  1.2531474
5 -1.1663747 -0.3285038  0.3593411
6 -0.2958043 -0.4433927 -0.7176240</code></pre>
</div>
<p>10個の主成分を用いてランダムフォレストで学習をします。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
vote_rf3 &lt;- train(
  target ~ .,
  data = data_train_pca %&gt;% 
    select(-sex, -educ, -job),
  method = &quot;rf&quot;
)

train_rf3 &lt;- confusionMatrix(predict(vote_rf3, data_train_pca), data_train_pca$target)
test_rf3 &lt;- confusionMatrix(predict(vote_rf3, data_test_pca), data_test_pca$target)
print(str_c(&quot;Accuracy (train):&quot;, train_rf3$overall[1]))</code></pre>
<pre><code>
[1] &quot;Accuracy (train):1&quot;</code></pre>
<pre class="r"><code>
print(str_c(&quot;Accuracy (test) :&quot;, test_rf3$overall[1]))</code></pre>
<pre><code>
[1] &quot;Accuracy (test) :0.750865051903114&quot;</code></pre>
</div>
<p>今回も若干ではありますが予測精度が改善しました。 ただし、主成分分析は機械学習によって主成分を求めるので、それが一体何を意味しているのかは解釈しないといけないという欠点があります。 やはり、まずはドメイン知識に基づく特徴選択が第1の方法のように思えます。</p>
<h3>正則化</h3>
<p>正則化あるいはshrinkageによって学習と特徴抽出を同時に行うこともできます。 具体的には、LASSO, Ridge, Elastic Netといった手法があります。</p>
<p>直観的に言えば、これらの手法では、回帰分析をする際に、効果が大きな変数に対しては効果が小さくなるような制約がかけられています。 そのため、「罰則付き回帰」と呼ばれることもあります。</p>
<p>罰則がつくことによって、</p>
<ul>
<li>いらない変数の効果が0になりやすくなる(LASSO)</li>
<li>訓練データに対する過学習が抑えられる(Ridge)</li>
</ul>
<p>といったご利益が期待されます（Elastic Netはその中間）。</p>
<p><code>caret</code>では正則化ロジスティック回帰の場合は<code>method</code>を<code>glmnet</code>にします。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
vote_logit1 &lt;- train(
  target ~ .,
  data = data_train,
  method = &quot;glmnet&quot;
)

train_logit1 &lt;- confusionMatrix(predict(vote_logit1, data_train), data_train$target)
test_logit1 &lt;- confusionMatrix(predict(vote_logit1, data_test), data_test$target)
print(str_c(&quot;Accuracy (train):&quot;, train_logit1$overall[1]))</code></pre>
<pre><code>
[1] &quot;Accuracy (train):0.74108170310702&quot;</code></pre>
<pre class="r"><code>
print(str_c(&quot;Accuracy (test) :&quot;, test_logit1$overall[1]))</code></pre>
<pre><code>
[1] &quot;Accuracy (test) :0.709342560553633&quot;</code></pre>
</div>
<p>残念ながら、今回の例では予測精度は下がってしまいました。</p>
<h2 id="CV">交差検証</h2>
<p>このように、機械学習ではモデル選択や特徴量エンジニアリングにおいて人間が判断する余地が大きいです。 したがって、いろいろなモデルや特徴量で機械学習を行い、よりよいものを見つけていくことが必要になります。</p>
<p>そこで問題となるのは、検証データに過学習してしまう可能性です。 つまり、モデルAとモデルBの予測精度を検証データによって求め、より高い方を選択する、という工程を繰り返すことで、検証データに都合のいいモデルが選ばれてしまうかもしれません。</p>
<p>この問題に対処するための方法が交差検証(cross validation: CV)と呼ばれるものです。 ここでは、その中でもK-fold CVについて説明をします。</p>
<figure>
<img src="https://upload.wikimedia.org/wikipedia/commons/1/1c/K-fold_cross_validation_EN.jpg" alt="K-fold CV" /><figcaption>K-fold CV</figcaption>
</figure>
<p>まず、データをK個に分割します。 そして、1番目のデータを検証データ、それ以外を訓練データとして学習をします。 その後、最初のデータを使って予測精度を求めます。 次のステップでは2番目のデータを検証データ、それ以外を訓練データとして学習と検証を行います。 これをK回繰り返して予測精度の平均値を求めます。</p>
<p>こうすることで、訓練データの中に擬似的な検証データを作ることができ、検証データに過学習することがなくなります。</p>
<aside>
あるいは、訓練データ、検証データに加えて評価データが必要だというふうに言うこともできます。
</aside>
<p><code>caret</code>では<code>train()</code>内で<code>trControl = trainControl(method = &quot;cv&quot;)</code>とすると、CVを行います。 分析結果のオブジェクト（今回の例では<code>vote_logit2</code>）の中に学習内容が書いてあります。 10-fold CVが行われていたことがわかります。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
vote_logit2 &lt;- train(
  target ~ .,
  data = data_train,
  method = &quot;glmnet&quot;,
  trControl = trainControl(method = &quot;cv&quot;)
)

vote_logit2</code></pre>
<pre><code>
glmnet 

869 samples
 59 predictor
  2 classes: &#39;0&#39;, &#39;1&#39; 

No pre-processing
Resampling: Cross-Validated (10 fold) 
Summary of sample sizes: 782, 782, 782, 783, 782, 782, ... 
Resampling results across tuning parameters:

  alpha  lambda        Accuracy   Kappa     
  0.10   0.0002037132  0.7064689  0.16009175
  0.10   0.0020371323  0.7053328  0.15033014
  0.10   0.0203713235  0.7145282  0.14463903
  0.55   0.0002037132  0.7064822  0.15725609
  0.55   0.0020371323  0.7053194  0.14255749
  0.55   0.0203713235  0.7318498  0.14233046
  1.00   0.0002037132  0.7064822  0.15725609
  1.00   0.0020371323  0.7053194  0.14013555
  1.00   0.0203713235  0.7329992  0.09327543

Accuracy was used to select the optimal model using the largest value.
The final values used for the model were alpha = 1 and lambda = 0.02037132.</code></pre>
</div>
<p>いろいろよくわからない数字が出ていますが、それは10回求めた予測精度では<strong>ありません</strong>。 実は、これはハイパーパラメータと呼ばれるものになります。</p>
<h3>ハイパーパラメータのチューニング</h3>
<p>いくつかの機械学習では自動的に推定されず、人間の手で決めなければならないパラメータがあり、それらをハイパーパラメータと呼びます。 そして、ハイパーパラメータのチューニングもモデル選択や特徴量エンジニアリングと同様、検証データに過学習を起こし得ます。</p>
<p>実は、<code>caret</code>では自動でハイパーパラメータのチューニングを行ってくれるのですが、その際の予測精度を求める方法が10-fold CVだったわけです。 つまり、<code>alpha</code>と<code>lambda</code>というハイパーパラメータについていくつかの組み合わせに関して10-fold CVを行い、予測精度の平均値を求め、それが最も高い組み合わせを採用しているのです。 学習結果の最後に、<code>The final values used for the model were ...</code>と書いてあるのがわかります。</p>
<p>さて、ハイパーパラメータの範囲は自分で決めることができます。 例えば、デフォルトでは上記のように各ハイパーパラメータの値が3つずつ選ばれていますが、5ずつにすることもできます。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
vote_logit3 &lt;- train(
  target ~ .,
  data = data_train,
  method = &quot;glmnet&quot;,
  trControl = trainControl(method = &quot;cv&quot;),
  tuneLength = 5
)

vote_logit3</code></pre>
<pre><code>
glmnet 

869 samples
 59 predictor
  2 classes: &#39;0&#39;, &#39;1&#39; 

No pre-processing
Resampling: Cross-Validated (10 fold) 
Summary of sample sizes: 782, 782, 782, 782, 783, 782, ... 
Resampling results across tuning parameters:

  alpha  lambda        Accuracy   Kappa      
  0.100  9.455529e-05  0.7077386  0.174875772
  0.100  4.388868e-04  0.7077386  0.174875772
  0.100  2.037132e-03  0.7065891  0.170266815
  0.100  9.455530e-03  0.7112002  0.171303891
  0.100  4.388868e-02  0.7238305  0.137092038
  0.325  9.455529e-05  0.7077386  0.174875772
  0.325  4.388868e-04  0.7077386  0.174875772
  0.325  2.037132e-03  0.7054397  0.165873805
  0.325  9.455530e-03  0.7100374  0.154127146
  0.325  4.388868e-02  0.7295777  0.087085958
  0.550  9.455529e-05  0.7077386  0.174875772
  0.550  4.388868e-04  0.7065891  0.170331813
  0.550  2.037132e-03  0.7088880  0.172072222
  0.550  9.455530e-03  0.7100241  0.141632401
  0.550  4.388868e-02  0.7295777  0.052252876
  0.775  9.455529e-05  0.7054264  0.168181217
  0.775  4.388868e-04  0.7065891  0.170331813
  0.775  2.037132e-03  0.7077252  0.167817729
  0.775  9.455530e-03  0.7192462  0.152655088
  0.775  4.388868e-02  0.7238172  0.003601108
  1.000  9.455529e-05  0.7054264  0.168181217
  1.000  4.388868e-04  0.7065891  0.170331813
  1.000  2.037132e-03  0.7077386  0.165622932
  1.000  9.455530e-03  0.7238305  0.157213125
  1.000  4.388868e-02  0.7238172  0.000000000

Accuracy was used to select the optimal model using the largest value.
The final values used for the model were alpha = 0.325 and lambda = 0.04388868.</code></pre>
</div>
<p>さらに、学習結果を<code>plot()</code>あるいは<code>ggplot()</code>に入れると、ハイパーパラメータと予測精度の関係が可視化されます。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
ggplot(vote_logit3)</code></pre>
<p><img src="cross-validation_files/figure-html5/unnamed-chunk-16-1.png" width="624" /></p>
</div>
<p>結果を理解するために、もう少し正則化について解説をします。 <code>Mixing Percentage</code>とは<code>alpha</code>のことで、0であればRidgeになり、1であればLASSOに、0から1の間の場合はElastic Netになります。 一方、<code>Regularization Parameter</code>とは<code>lambda</code>のことで、罰則の強さを意味します。 罰則が0であればロジスティック回帰と同じですが、大きくなるに連れて正則化の効果が大きくなります。</p>
<p><code>caret</code>では<code>tuneGrid</code>のオプションを使うことで、自らハイパーパラメータの値を設定することができます。</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
vote_logit4 &lt;- train(
  target ~ .,
  data = data_train,
  method = &quot;glmnet&quot;,
  trControl = trainControl(method = &quot;cv&quot;),
  tuneGrid = expand.grid(alpha = 0:10/10, lambda = 0:10/5)
)

train_logit4 &lt;- confusionMatrix(predict(vote_logit4, data_train), data_train$target)
test_logit4 &lt;- confusionMatrix(predict(vote_logit4, data_test), data_test$target)
print(str_c(&quot;Accuracy (train):&quot;, train_logit4$overall[1]))</code></pre>
<pre><code>
[1] &quot;Accuracy (train):0.742232451093211&quot;</code></pre>
<pre class="r"><code>
print(str_c(&quot;Accuracy (test) :&quot;, test_logit4$overall[1]))</code></pre>
<pre><code>
[1] &quot;Accuracy (test) :0.740484429065744&quot;</code></pre>
</div>
<p>ハイパーパラメータのチューニングにより正則化ロジスティック回帰の予測精度をちょっとだけ上げることができました。</p>
<!--radix_placeholder_article_footer-->
<div class="article-footer">
  <p class="social_footer">
    <span class="disqus-comments">
      <i class="fas fa-comments"></i>
      &nbsp;
      <span class="disqus-comment-count" data-disqus-identifier="posts/2019-05-27-cross-validation/">Comment on this article</span>
    </span>
    <span class="article-sharing">
      Share: &nbsp;
      <a href="https://twitter.com/share?text=R%E3%81%A7%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92%EF%BC%9A%E4%BA%A4%E5%B7%AE%E6%A4%9C%E8%A8%BC%E7%B7%A8&amp;url=https%3A%2F%2Fshohei-doi.github.io%2Fnotes%2Fposts%2F2019-05-27-cross-validation%2F">
        <i class="fab fa-twitter"></i>
      </a>
      <a href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p[url]=https%3A%2F%2Fshohei-doi.github.io%2Fnotes%2Fposts%2F2019-05-27-cross-validation%2F">
        <i class="fab fa-facebook"></i>
      </a>
      <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fshohei-doi.github.io%2Fnotes%2Fposts%2F2019-05-27-cross-validation%2F&amp;title=R%E3%81%A7%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92%EF%BC%9A%E4%BA%A4%E5%B7%AE%E6%A4%9C%E8%A8%BC%E7%B7%A8">
        <i class="fab fa-linkedin"></i>
      </a>
    </span>
  </p>
  <script id="dsq-count-scr" src="https://notes-shohei-doi.disqus.com/count.js" async></script>
  <div id="disqus_thread" class="hidden"></div>
  <script>
var disqus_config = function () {
  this.page.url = 'https://shohei-doi.github.io/notes/posts/2019-05-27-cross-validation/';
  this.page.identifier = 'posts/2019-05-27-cross-validation/';
};
(function() {
  var d = document, s = d.createElement('script');
  s.src = 'https://notes-shohei-doi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>
  <p>
    <div class="subscribe"><form method='post' action='https://blogtrottr.com'>
  <p>Enjoy this blog? Get notified of new posts via email:</p>
  <input type='text' name='btr_email' />
  <input type='hidden' name='btr_url'
         value='https://beta.rstudioconnect.com/content/3776/index.xml'/>
  <input type='hidden' name='schedule_type' value='0' />
  <input type='submit' value='Subscribe' />
</form>
</div>
  </p>
</div>
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
